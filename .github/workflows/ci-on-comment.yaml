name: Run Workflow on PR Comment
on:
  issue_comment:
    types: [created]
  
jobs:
  pre-comment:
    if: github.event.issue.pull_request
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Build dynamic PR comment
        id: build_comment
        run: |
          GH_URL=https://github.com/Labbyn/labbyn/actions/${{ github.run_id }}
          COMMENT="## ðŸ¤– Tests triggered - ($GH_URL):"
          
          if [[ "${{ github.event.comment.body }}" =~ "/test api" ]]; then
            COMMENT+="âœ… [Run API Tests]"
          fi

          if [[ "${{ github.event.comment.body }}" =~ "/test frontend" ]]; then
            COMMENT+="âœ… [Run Frontend Tests]"
          fi

          if [[ "${{ github.event.comment.body }}" =~ "/test prometheus" ]]; then
            COMMENT+="âœ… [Run Prometheus Tests]"
          fi

          if [[ "${{ github.event.comment.body }}" =~ "/test grafana" ]]; then
            COMMENT+="âœ… [Run Grafana Tests]"
          fi

          echo "comment_body=$COMMENT" >> $GITHUB_OUTPUT
      - name: Post PR comment
        uses: peter-evans/create-or-update-comment@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: ${{ steps.build_comment.outputs.comment_body }}

  run-api-test-set:
    if: github.event.issue.pull_request && (contains(github.event.comment.body, '/test all') || contains(github.event.comment.body, '/test api'))
    uses: ./.github/workflows/ci-api.yaml
  run-frontend-test-set:
    if: github.event.issue.pull_request && (contains(github.event.comment.body, '/test all') || contains(github.event.comment.body, '/test frontend'))
    uses: ./.github/workflows/ci-frontend.yaml
  run-prometheus-test-set:
    if: github.event.issue.pull_request && (contains(github.event.comment.body, '/test all') || contains(github.event.comment.body, '/test prometheus'))
    uses: ./.github/workflows/ci-monitoring.yaml
    with:
        monitoring-tool: 'prometheus'
  run-grafana-test-set:
    if: github.event.issue.pull_request && (contains(github.event.comment.body, '/test all') || contains(github.event.comment.body, '/test grafana'))
    uses: ./.github/workflows/ci-monitoring.yaml
    with:
        monitoring-tool: 'grafana'
